<Window x:Class="start_wpf1.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:start_wpf1"
        xmlns:models="clr-namespace:start_wpf1.Models"
        xmlns:vm="clr-namespace:start_wpf1.ViewModels"  
        xmlns:helpers="clr-namespace:start_wpf1.Helpers"
        Title="STM32 USB Composite Communicator" Height="650" Width="800">
    <Window.Resources>
        <helpers:InverseBoolConverter x:Key="InverseBoolConverter"/>
    </Window.Resources>


    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <GroupBox Header="Kết nối thiết bị" Grid.Row="0" Margin="0,0,0,10">
            <StackPanel Orientation="Horizontal" Margin="5">
                <Label Content="Trạng thái:" FontWeight="Bold"/>
                <TextBlock x:Name="txtConnectionStatus" Text="Chưa kết nối" VerticalAlignment="Center" Margin="5,0"/>
                <Label Content="Tên thiết bị:" FontWeight="Bold" Margin="20,0,0,0"/>
                <TextBlock x:Name="txtDeviceName" Text="N/A" VerticalAlignment="Center" Margin="5,0"/>
            </StackPanel>
        </GroupBox>

        <TabControl Grid.Row="1">
            <TabItem Header="CDC qua UART">
                <Grid Margin="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="4*"/>
                        <ColumnDefinition Width="6*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <GroupBox Header="Cấu hình UART" Grid.Row="0" Grid.Column="0" Margin="0,0,10,10"
          HorizontalAlignment="Stretch" VerticalAlignment="Top">
                        <StackPanel Margin="5" Orientation="Vertical">

                            <!-- Dòng 1: COM + Baudrate + Hiển thị kiểu dữ liệu -->
                            <WrapPanel Margin="0,5,0,0" VerticalAlignment="Center">
                                <Label Content="COM :" VerticalAlignment="Center"/>
                                <ComboBox x:Name="cmbComPorts" Width="70" Margin="5,0"
          ItemsSource="{Binding CdcVM.AvailablePorts}"
          SelectedItem="{Binding CdcVM.SelectedPort}" />

                                <Label Content="Baud :" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                <ComboBox x:Name="cmbBaudRate" Width="70" Margin="5,0"
          SelectedItem="{Binding CdcVM.SelectedBaudRate}">
                                    <ComboBoxItem Content="9600"/>
                                    <ComboBoxItem Content="19200"/>
                                    <ComboBoxItem Content="38400"/>
                                    <ComboBoxItem Content="115200" IsSelected="True"/>
                                    <ComboBoxItem Content="230400"/>
                                    <ComboBoxItem Content="460800"/>
                                    <ComboBoxItem Content="921600"/>
                                </ComboBox>
                                
                            </WrapPanel>

                            <!-- Dòng 2: DataBits + Parity + StopBits -->
                            <WrapPanel Margin="0,5,0,0" VerticalAlignment="Center">
                                
                                <Label Content="Data Bits:" VerticalAlignment="Center"/>
                                <ComboBox x:Name="cmbDataBits" Width="50" Margin="5,0" 
                                          SelectedItem="{Binding CdcVM.SelectedDataBits}">
                                    <ComboBoxItem Content="7"/>
                                    <ComboBoxItem Content="8" IsSelected="True"/>
                                </ComboBox>

                                <Label Content="Parity:" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                <ComboBox x:Name="cmbParity" Width="70" Margin="5,0" 
                                          SelectedItem="{Binding CdcVM.SelectedParity}">
                                    <ComboBoxItem Content="None" IsSelected="True"/>
                                    <ComboBoxItem Content="Odd"/>
                                    <ComboBoxItem Content="Even"/>
                                </ComboBox>

                                <Label Content="Stop Bits:" Margin="1,0,0,0" VerticalAlignment="Center"/>
                                <ComboBox x:Name="cmbStopBits" Width="50" Margin="5,0" 
                                          SelectedItem="{Binding CdcVM.SelectedStopBits}">
                                    <ComboBoxItem Content="One" IsSelected="True"/>
                                    <ComboBoxItem Content="Two"/>
                                </ComboBox>
                                <Label Content="Display:" Margin="1,0,0,0" VerticalAlignment="Center"/>
                                <ComboBox x:Name="cmbDisplayMode" Width="70" Margin="5,0" SelectedIndex="0">
                                    <ComboBoxItem Content="ASCII"/>
                                    <ComboBoxItem Content="Hex"/>
                                    <ComboBoxItem Content="Dec"/>
                                </ComboBox>
                            </WrapPanel>

                            <!-- Dòng 3: CR LF + Mở/Đóng COM -->
                            <WrapPanel Margin="0,10,0,0">
                                <CheckBox Content="CR" Margin="0,0,10,0" IsChecked="{Binding CdcVM.AppendCR}" />
                                <CheckBox Content="LF" Margin="0,0,20,0" IsChecked="{Binding CdcVM.AppendLF}" />

                                <Button Content="Open COM"
        Command="{Binding CdcVM.OpenComCommand}"
        IsEnabled="{Binding CdcVM.IsSerialOpen, Converter={StaticResource InverseBoolConverter}}"
        Width="70" Margin="0,0,10,0" />

                                <Button Content="Close COM"
        Command="{Binding CdcVM.CloseComCommand}"
        IsEnabled="{Binding CdcVM.IsSerialOpen}"
        Width="80" />

                            </WrapPanel>

                        </StackPanel>
                    </GroupBox>


                    <TabControl Grid.Row="1" Grid.Column="0" Margin="0,0,10,0">
                        <TabItem Header="Gửi từng dòng">
                            <!--  <GroupBox Header="Gửi dữ liệu" Grid.Row="1" Grid.Column="0" Margin="0,0,10,0"> -->
                            <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <DataGrid x:Name="dgCdcSend" Grid.Row="0" AutoGenerateColumns="False" CanUserAddRows="True" CanUserDeleteRows="True"
                                      HeadersVisibility="Column" SelectionMode="Single">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Data" Binding="{Binding DataString, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                                    <DataGridTemplateColumn Header="Type" Width="80">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ComboBox SelectedValue="{Binding DataType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                      SelectedValuePath="Content">
                                                    <ComboBoxItem Content="ASCII" />
                                                    <ComboBoxItem Content="Hex" />
                                                    <ComboBoxItem Content="Dec" />
                                                </ComboBox>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>

                                        <DataGridTemplateColumn.CellEditingTemplate>
                                            <DataTemplate>
                                                <ComboBox SelectedValue="{Binding DataType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                      SelectedValuePath="Content">
                                                    <ComboBoxItem Content="ASCII" />
                                                    <ComboBoxItem Content="Hex" />
                                                    <ComboBoxItem Content="Dec" />
                                                </ComboBox>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellEditingTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTemplateColumn Header="Gửi" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                    <Button Content="Gửi"
        Command="{Binding DataContext.CdcVM.SendCommand, RelativeSource={RelativeSource AncestorType=Window}}"
        CommandParameter="{Binding}"
        IsEnabled="{Binding DataContext.CdcVM.IsSerialOpen, RelativeSource={RelativeSource AncestorType=Window}}" />
                                                </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                          <!--  </GroupBox> -->
                        </TabItem>
                        <!-- Tab 2: Gửi file / lưu log -->
                        <TabItem Header="Gửi file / Lưu log">
                            
                                <StackPanel Margin="20">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                                    <Button Content="Gửi file"
        Command="{Binding CdcVM.SendFileCommand}"
        IsEnabled="{Binding CdcVM.IsSerialOpen}" Width="100" Margin="0,0,10,0"/>
                                    <TextBlock Text="{Binding CdcVM.LastSentFileName}" VerticalAlignment="Center"/>

                                </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <Button Content="Lưu log" Command="{Binding CdcVM.SaveLogCommand}" Width="100"/>

                                    <TextBlock Text=" Lưu toàn bộ dữ liệu nhận được" Margin="10,0"/>
                                    </StackPanel>
                                </StackPanel>
                           
                        </TabItem>
                    </TabControl>

                    <GroupBox Header="Nhận dữ liệu" Grid.Row="0" Grid.Column="1" Grid.RowSpan="2" Margin="10,0,0,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBox x:Name="txtReceiveLog"
         FontFamily="Consolas"
         FontSize="14"
         IsReadOnly="True"
         TextWrapping="NoWrap"
         VerticalScrollBarVisibility="Auto"
         HorizontalScrollBarVisibility="Auto"
         AcceptsReturn="True"
         AcceptsTab="True" /> 


                            <StackPanel Orientation="Horizontal" Grid.Row="1" HorizontalAlignment="Right" Margin="0,5,0,0">

                                <Button Content="Xóa"
        Command="{Binding CdcVM.ClearReceiveCommand}"
        Margin="0,0,0,0"/>

                            </StackPanel>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>

            <TabItem Header="USB HID qua CAN Protocol" >
                <Grid Margin="10"  DataContext="{Binding CanVM}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <GroupBox Header="Cấu hình CAN Protocol" Grid.Row="0" Grid.Column="0" Margin="0,0,10,10"
          HorizontalAlignment="Stretch" VerticalAlignment="Top">
                        <StackPanel Margin="5">
                           


                            <StackPanel Orientation="Horizontal" Margin="0,0,0,0">
                                <Label Content="Baud Rate (kbit/s):" />
                                <ComboBox Margin="15,0,0,0" Width="90" ItemsSource="{Binding Config.BaudRateOptions}"
                                            SelectedItem="{Binding Config.SelectedBaudRate}" />
                            </StackPanel>

                            <GroupBox Header="CAN ID Filter" Margin="0,5,0,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,5,0,5">
                                        <RadioButton Content="Standard (11-bit ID)"
             IsChecked="{Binding Config.IsStandardIdFilter, Mode=TwoWay}" />
                                        <RadioButton Content="Extended (29-bit ID)"
             IsChecked="{Binding Config.IsExtendedIdFilter, Mode=TwoWay}" Margin="15,0,0,0"/>
                                    </StackPanel>

                                    <Grid Margin="0,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="From ID(Hex):" VerticalAlignment="Center"/>
                                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Config.FilterFromId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="100" HorizontalAlignment="Left" Margin="5,0"/>


                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="To ID(Hex):" VerticalAlignment="Center" Margin="0,5,0,0"/>
                                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Config.FilterToId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="100" HorizontalAlignment="Left" Margin="5,5,0,0"/>
                                    </Grid>

                                    <Button Content="Default Values" Command="{Binding Config.SetDefaultFilterValuesCommand}" Margin="0,5,0,0" HorizontalAlignment="Left" Padding="10,3"/>
                                </StackPanel>
                            </GroupBox>

                            <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                <Button Content="Kết nối CAN"
                    Command="{Binding ConnectCanCommand}"
                    Margin="0,0,30,0"
                    IsEnabled="{Binding IsDisconnected}"/>
                                <Button Content="Ngắt kết nối CAN"
                    Command="{Binding DisconnectCanCommand}"
                    IsEnabled="{Binding IsConnected}"/>
                            </StackPanel>

                        </StackPanel>
                    </GroupBox>
                    
                    <GroupBox Header="Gửi CAN Frame" Grid.Row="1" Grid.Column="0" Margin="0,0,10,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <DataGrid x:Name="dgCanSend" ItemsSource="{Binding CanFrames}" AutoGenerateColumns="False" CanUserAddRows="True" CanUserDeleteRows="True">
                    
                                <DataGrid.Columns>
                                    
                                    
                                    
                                    <DataGridTextColumn Header="CAN ID" Binding="{Binding CanId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="80"/>

                                    <DataGridTemplateColumn Header="Type" Width="80">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ComboBox
                ItemsSource="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.CanVM.FrameTypeOptions}"
                SelectedItem="{Binding FrameType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Width="70"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <DataGridTemplateColumn Header="DLC" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ComboBox
                                                            ItemsSource="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.CanVM.DlcOptions}"
                                                            SelectedItem="{Binding Dlc, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                            Width="50"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                
                                    
                                    <!-- Hiển thị từng byte nhập -->
                                    <DataGridTemplateColumn Header="Data" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ItemsControl ItemsSource="{Binding VisibleDataBytes}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <StackPanel Orientation="Horizontal"/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" Width="30" Margin="1"/>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridCheckBoxColumn Header="Cycle" Binding="{Binding IsCyclic}" Width="60"/>
                                    <DataGridTextColumn Header="Time (ms)" Binding="{Binding CycleTimeMs}" Width="80"/>
                                    <DataGridCheckBoxColumn Header="Event" Binding="{Binding IsEventTriggered}" Width="60"/>

                                    <!-- Gửi -->
                                    <DataGridTemplateColumn Header="Gửi" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="Gửi"
                            Command="{Binding DataContext.SendCanFrameCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                            CommandParameter="{Binding}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>

                        </Grid>
                    </GroupBox>
            
                    <GroupBox Header="Nhận CAN Frames" Grid.Row="0" Grid.Column="1" Grid.RowSpan="2" Margin="10,0,0,0">
                        
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <DataGrid x:Name="dgCanReceive"
                                              ItemsSource="{Binding ReceivedFrames}"
                                              AutoGenerateColumns="False"
                                              IsReadOnly="True">
                                <DataGrid.Columns>
                                    <!-- CAN ID -->
                                    <DataGridTextColumn Header="CAN ID" Binding="{Binding CanId}" Width="70"/>

                                    <!-- Frame Type -->
                                    <DataGridTextColumn Header="Type" Binding="{Binding FrameType}" Width="60"/>

                                    <!-- DLC -->
                                    <DataGridTextColumn Header="DLC" Binding="{Binding Dlc}" Width="30"/>

                                    <!-- Data (hex) -->
                                    <DataGridTextColumn Header="Data" Binding="{Binding DataHex}" Width="*"/>

                                    <!-- Cycle -->
                                    <DataGridTextColumn Header="Cycle" Binding="{Binding CycleTimeMs}" Width="70"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal" Grid.Row="1" HorizontalAlignment="Right" Margin="0,5,0,0">
                            
                                <Button x:Name="btnClearCanReceive" Content="Xóa" Margin="0,0,0,0" Click="btnClearCanReceive_Click"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>
                    
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</Window>